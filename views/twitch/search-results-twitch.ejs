<%- include('../partials/header') %>
<%- include('../partials/subheader-twitch') %>


<div class="jumbotron bg-dark text-light">
    <div class="container text-center">
        <img class="mt-0" width="175" height="100" src="https://www.freepnglogos.com/uploads/twitch-tv-logo-png-1.png"
            alt="">
        <% if (paginate.baseUrl != "/twitch/search/tags"){ %>
        <h1 class="slogan display-4 my-4">best Twitch streams matching "<%= searchQuery%>"</h1>
        <% } else {%>
        <h1 class="slogan display-4 my-4">Best <%= tag %> Twitch Streamers</h1>

        <%}%>
        <form method="post" action="/twitch/search" class="mx-auto">
            <input name="query" class="form-control mr-sm-2" type="search" placeholder="Search streamers..."
                aria-label="Search" />
            <button class="btn twitch-button mt-2" type="submit">
                Search
            </button>
        </form>
      
    </div>
</div>

<!-- <div class="row"> -->
    <!-- <div class="col">
        
    </div> -->
    <!-- <div class="col-6"> -->


        <div id="card-container" class="container w-50">

            <div class="card-header mb-3 mx-auto bg-white text-black">
                <div class="row">
                    <div class="col-sm text-black text-left">
                        <% if (paginate.baseUrl != "/twitch/search/tags"){ %>
        <p class="mb-0">search results for "<%= searchQuery%>"</p>
        <% } else {%>
        <h5 class="mb-0"><a class="text-dark"
                href="<%=paginate.baseUrl%>?page=<%= paginate.page %><%= tag ? "&tag="+tag : null%>">Category:
                <%= tag %></a></h5>
        <%}%>
            </div>
            <div class="col-sm text-black text-right">

                <h5 class="mb-0">sort by:
                    <span>
                    <a
                        class=""href="<%=paginate.baseUrl%>?page=<%= paginate.page %><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %>&sort=upvotes">
        upvotes
        </a>
        /
        <a class=""
            href="<%=paginate.baseUrl%>?page=<%= paginate.page %><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %>&sort=recent">
            recent
        </a>
        </span>
        </h5>
    </div>
</div>
</div>


<% if ((paginate.baseUrl == "/twitch/search/tags" && tag == "Music") || paginate.baseUrl == "/twitch/search/tags" && tag == "Education" ){ %>

<div class="card mb-3 mx-auto">
    <h3 class="card-header">
        <a class="text-black" href="https://2257090kz4kde26cn2xfk3t85e.hop.clickbank.net/">Pianoforall
        </a>
    </h3>
    <p class="m-3 text-right">
        <a class="text-black" href="https://2257090kz4kde26cn2xfk3t85e.hop.clickbank.net/">
            <em>#Featured</em></a>
    </p>

    <a href="https://2257090kz4kde26cn2xfk3t85e.hop.clickbank.net/" class="mt-3 align-self-center"><img
            src="https://pianoforall.com/wp-content/uploads/2018/09/Pianoforall-life-a200x200.gif"
            class=" mx-auto img-fluid img-thumbnail" alt="card-image"></a>
    <div class="card-body">
        <p class="card-text">Do you regret that you never learned piano? Do you want to sound great from the
            start?
            Learn Piano And Keyboards From Pianoforall - One Of The Top Piano Methods.</p>
        <a href="https://2257090kz4kde26cn2xfk3t85e.hop.clickbank.net/" class="btn twitch-button">Learn More</a>
    </div>
</div>
<% } %>


<% results.forEach((channel) => { %>

<div class="card mb-3 mx-auto">
    <h3 class="card-header"> <a href=<%= channel.link %> target="_blank" class="text-dark"><%= channel.name %></a>
    </h3>
    <p class="m-3 text-right">
        <a class="text-black" href="/twitch/search/tags?page=1&tag=<%= channel.tags[0] %>&sort=upvotes">
            <em>#<%= channel.tags[0] %></em></a>
    </p>

    <div class="row pt-3 mx-auto">
        <img src="<%= channel.image %>" class="thumb mx-auto img-fluid img-thumbnail align-self-center"
            alt="channel thumbnail">
        <div class="p-3 p-md-4 mx-auto ml-md-4 text-center align-self-center">
            <% let thisChannel %>
            <% let pastDirection %>
            <% if(user){ %>
            <% if (!votedChannelsArray.length){  %>
            <%  thisChannel = -1 %>
            <%  pastDirection = "none" %>
            <% } else if (votedChannelsArray.indexOf(String(channel._id)) != -1){ %>
            <%  thisChannel = votedChannelsArray.indexOf(String(channel._id)) %>
            <%  pastDirection = user.votedChannels[thisChannel].direction %>
            <%}%>
                <button id="up<%= channel._id %>" name="upvote" class="btn row"
            <%= thisChannel != -1 && pastDirection === "up" ? "disabled" : null %>>
            <i class="fas fa-chevron-up fa-3x"></i>
            </button>

            <h1 id=<%= channel._id %> class="row p-0 m-0 justify-content-center">
                <%= channel.votes %></h1>

            <button id="down<%= channel._id %>" name="downvote" class="btn row"
                <%= thisChannel != -1 && pastDirection==="down" ? "disabled" : null %>>
                <i class="fas fa-chevron-down fa-3x"></i>
            </button>
            <% } else { %>
            <button id=" up<%= channel._id %>" name="upvote" class="btn row">
                <i class="fas fa-chevron-up fa-3x"></i>
            </button>

            <h1 id=<%= channel._id %> class="row p-0 m-0 justify-content-center">
                <%= channel.votes %></h1>

            <button id="down<%= channel._id %>" name="downvote" class="btn row">
                <i class="fas fa-chevron-down fa-3x"></i>
            </button>
            <% } %>

        </div>
    </div>
    <div class="card-body">
        <p class="description card-text"><%= channel.description %></p>

        <a href=<%= channel.link %> target="_blank" class="btn twitch-button">Visit channel</a>
    </div>
</div>
<% }) %>

</div>
<!-- </div> -->
<!-- <div class="col">
</div> -->
<!-- </div> -->

<nav aria-label="results pages" class="d-flex justify-content-center">

    <ul id="paginate" class="pagination pagination-twitch">
        <li class="page-item <%= paginate.previousPage === 0 ? "disabled" : null %>">
            <a class="page-link"
                href="<%=paginate.baseUrl%>?page=<%= 1%><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %><%= sortOption ? "&sort="+sortOption : null%>"
                tabindex="-1">First</a>
        </li>

        <li class="page-item <%= paginate.previousPage === 0 ? "disabled" : null %>">
            <a class="page-link"
                href="<%=paginate.baseUrl%>?page=<%= paginate.page -1%><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %><%= sortOption ? "&sort="+sortOption : null%>"
                tabindex="-1">Previous</a>
        </li>
        <% if ((paginate.page + 1 > paginate.numberOfPages) && (paginate.numberOfPages != 1) && (paginate.page - 2 > 0)){ %>
        <li class="page-item">
            <a class=" page-link"
                href="<%=paginate.baseUrl%>?page=<%= paginate.page - 2%><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %><%= sortOption ? "&sort="+sortOption : null%>"><%= paginate.page -2 %></a>
        </li>
        <% } %>
        <% if (paginate.page -1 >= 1) { %>
        <li class="page-item">
            <a class=" page-link"
                href="<%=paginate.baseUrl%>?page=<%= paginate.page - 1%><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %><%= sortOption ? "&sort="+sortOption : null%>"><%= paginate.page -1%></a>
        </li>
        <%}%>
    
        <li class="page-item active">
            <a class=" page-link"
              href="<%=paginate.baseUrl%>?page=<%= paginate.page%><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %><%= sortOption ? "&sort="+sortOption : null%>"><%= paginate.page %></a>
        </li>
        <% if (paginate.page + 1 <= paginate.numberOfPages){ %>
        <li class="page-item">
            <a class=" page-link"
                href="<%=paginate.baseUrl%>?page=<%= paginate.page + 1%><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %><%= sortOption ? "&sort="+sortOption : null%>"><%= paginate.page + 1 %></a>
        </li>
        <% } %>
        <% if ((paginate.page -1 < 1) && (paginate.numberOfPages !=1) && (paginate.page + 2 <= paginate.numberOfPages)) { %>
        <li class="page-item">
            <a class=" page-link"
                href="<%=paginate.baseUrl%>?page=<%= paginate.page + 2%><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %><%= sortOption ? "&sort="+sortOption : null%>"><%= paginate.page +2%></a>
        </li>
        <%}%>
    
        <li class="page-item <%= paginate.nextPage === 0 ? "disabled" : null %>">
        <a class="page-link"
            href="<%=paginate.baseUrl%>?page=<%= paginate.page +1 %><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %><%= sortOption ? "&sort="+sortOption : null%>">Next</a>
        </li>
        <li class="page-item <%= paginate.nextPage === 0 ? "disabled" : null %>">
            <a class="page-link"
                href="<%=paginate.baseUrl%>?page=<%= paginate.numberOfPages %><%= tag ? "&tag="+tag : null %><%= searchQuery ? "&search="+searchQuery : null %><%= sortOption ? "&sort="+sortOption : null%>">Last</a>
        </li>


    </ul>
</nav>






<script>

    function upvote() {
        // console.log("upvote")
        const votes = event.target.parentElement.nextElementSibling.innerText
        const id = event.target.parentElement.nextElementSibling.attributes.id.value

        let xhr = new XMLHttpRequest()

        xhr.open('POST', '/twitch/vote', true)
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
        //xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.onload = function () {
            //console.log(this)
            if (this.status == 200 && !this.responseText.includes("<!DOCTYPE html>")) {
                const data = JSON.parse(this.responseText)
                document.getElementById(id).innerHTML = `${data.votes}`
                document.getElementById(`up${id}`).disabled = data.disabled.up
                document.getElementById(`down${id}`).disabled = data.disabled.down
            } else {
                document.getElementById(id).innerHTML = "sign in to vote"
            }
        }
        xhr.send(JSON.stringify({
            id: id,
            votes: votes,
            direction: "up"
        }))

    }

    function downvote() {
        // console.log("downvote")
        const votes = event.target.parentElement.previousElementSibling.innerText
        const id = event.target.parentElement.previousElementSibling.attributes.id.value
        let xhr = new XMLHttpRequest()

        console.log(votes, id)

        xhr.open('POST', '/twitch/vote', true)
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
        //xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.onload = function () {

            if (this.status == 200 && !this.responseText.includes("<!DOCTYPE html>")) {
                const data = JSON.parse(this.responseText)
                document.getElementById(id).innerHTML = `${data.votes}`
                document.getElementById(`up${id}`).disabled = data.disabled.up
                document.getElementById(`down${id}`).disabled = data.disabled.down
            } else {
                document.getElementById(id).innerHTML = "sign in to vote"
            }
        }
        xhr.send(JSON.stringify({
            id: id,
            votes: votes,
            direction: "down"
        }))

    }

    const ups = document.getElementsByName("upvote")
    ups.forEach((element) => { element.addEventListener("click", upvote) })

    const downs = document.getElementsByName("downvote")
    downs.forEach((element) => { element.addEventListener("click", downvote) })

    let x = window.matchMedia("(min-width: 992px)")
    dropdownRight(x) // Call listener function at run time
    x.addListener(dropdownRight) // Attach listener function on state changes 


</script>
<%- include('../partials/footer') %>